<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, viewport-fit=cover"
  />
  <title>Welcome to Our Salon ‚Ä¢ Quick Check-In</title>
  <style>
    :root {
      --bg1: #6440ff;
      --bg2: #a855f7;
      --ink: #121826;
      --muted: #718096;
      --card: #ffffff;
      --brand: #6d28d9;
      --brand-2: #7c3aed;
      --ok: #16a34a;
      --error: #dc2626;
      --border: #e5e7eb;
      --soft: #f8fafc;
    }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto,
        Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      color: var(--ink);
      background: radial-gradient(1200px 1200px at 10% -10%, var(--bg1), transparent 55%),
                  radial-gradient(900px 900px at 110% 10%, var(--bg2), transparent 50%),
                  #f3f4f6;
    }
    .wrap { max-width: 760px; margin: 40px auto; padding: 0 16px; }
    .card {
      background: var(--card);
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(17, 24, 39, .08);
      padding: 28px;
    }
    h1 { margin: 0 0 8px 0; font-size: 34px; line-height: 1.2; }
    .sub { color: var(--muted); margin-bottom: 20px; font-size: 15px; }
    .row { margin: 14px 0; }
    .label { display:block; font-weight: 600; margin-bottom: 8px; }
    .input, .select {
      width: 100%; padding: 12px 14px; border-radius: 10px; border: 1px solid var(--border);
      outline: none; font-size: 16px; box-sizing: border-box; background: #fff;
    }
    .input:focus, .select:focus { border-color: var(--brand); box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.14); }
    .grid-2 { display:grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .grid-3 { display:grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; }
    .svc {
      border: 1px solid var(--border); border-radius: 12px; padding: 12px 14px;
      display:flex; align-items:center; gap:10px; background:#fff; user-select:none; cursor:pointer;
    }
    .svc input { width:20px; height:20px; margin:0; accent-color: var(--brand); }
    .muted { color: var(--muted); }
    .banner {
      display:none; border-radius:10px; padding:12px 14px; margin:12px 0 14px 0;
      font-size:15px; border:1px solid transparent;
    }
    .banner.ok { display:block; background:#ecfdf5; color:#065f46; border-color:#a7f3d0; }
    .banner.error { display:block; background:#fef2f2; color:#991b1b; border-color:#fecaca; }
    .btn-primary {
      width:100%; appearance:none; border:0; border-radius:12px; padding:14px 16px;
      font-size:16px; font-weight:700; color:#fff;
      background: linear-gradient(135deg, var(--brand), var(--brand-2));
      cursor:pointer; box-shadow: 0 8px 20px rgba(124, 58, 237, .35);
      transition: transform .04s ease, filter .2s ease;
    }
    .btn-primary:disabled { opacity:.65; cursor:not-allowed; box-shadow:none; }
    .btn-primary:hover { filter: brightness(1.02); }
    .hint { font-size:13px; color:var(--muted); margin-top:6px; }
    .hidden { display:none !important; }

    /* Result card */
    .result-box { margin-top:10px; background:var(--soft); border:1px solid var(--border);
      border-radius:12px; padding:16px; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>‚ú® Welcome to Our Salon</h1>
      <div class="sub">Quick &amp; Easy Check-in</div>

      <!-- status banner -->
      <div id="banner" class="banner"></div>

      <!-- FORM -->
      <form id="checkin-form" onsubmit="handleSubmit(event)">
        <div id="form-fields">

          <!-- PHONE -->
          <div class="row">
            <label class="label" for="phone">üì± Phone Number *</label>
            <input id="phone" class="input" inputmode="numeric" autocomplete="tel"
                   placeholder="(123) 456-7890" maxlength="18" required />
            <div class="hint">We‚Äôll use this to find your profile and reward progress.</div>
          </div>

          <!-- SERVICES (always visible) -->
          <div class="row">
            <div class="label">What services are you here for today?</div>
            <div class="grid-3">
              <label class="svc"><input type="checkbox" value="Hair"       class="svc-chk" /> üíá‚Äç‚ôÄÔ∏è Hair</label>
              <label class="svc"><input type="checkbox" value="Makeup"     class="svc-chk" /> üíÑ Makeup</label>
              <label class="svc"><input type="checkbox" value="Eyebrows"   class="svc-chk" /> üëÅÔ∏è Eyebrows</label>
              <label class="svc"><input type="checkbox" value="Nails"      class="svc-chk" /> üíÖ Nails</label>
              <label class="svc"><input type="checkbox" value="Facial"     class="svc-chk" /> üßñ Facial</label>
              <label class="svc"><input type="checkbox" value="Other"      class="svc-chk" /> ‚ú® Other</label>
            </div>
          </div>

          <!-- EXTRA FIELDS (hidden until phone not found) -->
          <div id="extra-fields" class="hidden">
            <div class="row grid-2">
              <div>
                <label class="label" for="fullName">üë§ Full Name *</label>
                <input id="fullName" class="input" placeholder="Jane Doe" autocomplete="name" />
              </div>
              <div>
                <label class="label" for="email">‚úâÔ∏è Email (Optional)</label>
                <input id="email" class="input" type="email" placeholder="jane@example.com" autocomplete="email" />
              </div>
            </div>

            <div class="row grid-2">
              <div>
                <label class="label" for="birthday">üéÇ Birthday *</label>
                <input id="birthday" class="input" type="date" />
                <div class="hint">You‚Äôll get a birthday reward üéâ</div>
              </div>
              <div></div>
            </div>

            <!-- SMS opt-in (only shown when new profile required) -->
            <div class="row">
              <label class="svc" style="gap:12px;">
                <input id="smsOptin" type="checkbox" />
                <div>
                  üì≤ Send me exclusive offers &amp; rewards via SMS
                  <div class="hint">We‚Äôll only text about rewards and salon offers.</div>
                </div>
              </label>
            </div>
          </div>
        </div>

        <!-- Submit -->
        <div class="row">
          <button id="checkin-btn" class="btn-primary" type="submit">Check In</button>
        </div>
      </form>

      <!-- RESULT CARD (hidden until success) -->
      <div id="result-card" class="hidden">
        <div class="result-box">
          <h3 id="result-title" style="margin: 0 0 6px 0;">Thanks for checking in!</h3>
          <p id="result-sub" style="margin: 0 0 12px 0;" class="muted"></p>

          <div id="result-details" style="margin-bottom: 10px;">
            <p><strong>Services today:</strong> <span id="result-services">‚Äî</span></p>
            <p id="result-reward" class="hidden"><strong>üéÅ Reward:</strong> <span id="result-reward-text"></span></p>
            <p><em id="result-cashier-note"></em></p>
          </div>

          <button id="done-btn" type="button" class="btn-primary" onclick="resetForNextGuest()">
            Done
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // -----------------------------
    // Config
    // -----------------------------
    const ENDPOINT = 'https://princetonai.app.n8n.cloud/webhook-test/ai-checkin';

    // -----------------------------
    // Utilities
    // -----------------------------
    const $ = (id) => document.getElementById(id);

    function setBanner(msg, kind = 'ok') {
      const el = $('banner');
      if (!msg) { el.style.display = 'none'; el.className = 'banner'; el.textContent = ''; return; }
      el.textContent = msg;
      el.className = 'banner ' + (kind === 'error' ? 'error' : 'ok');
      el.style.display = 'block';
    }

    function genId() {
      return 'sub_' + Math.random().toString(36).slice(2) + Date.now().toString(36);
    }

    function unformatPhone(str) {
      return (str || '').replace(/\D/g, '').slice(0, 10);
    }
    function formatPhone(digits) {
      const s = (digits || '').replace(/\D/g, '').slice(0, 10);
      const a = s.slice(0, 3);
      const b = s.slice(3, 6);
      const c = s.slice(6, 10);
      if (s.length <= 3) return a;
      if (s.length <= 6) return `(${a}) ${b}`;
      return `(${a}) ${b}-${c}`;
    }
    // Smooth phone typing
    (function attachPhoneMask() {
      const el = $('phone');
      el.addEventListener('input', () => {
        const digits = unformatPhone(el.value);
        el.value = formatPhone(digits);
        const len = el.value.length;
        try { el.setSelectionRange(len, len); } catch (e) {}
      });
      el.addEventListener('blur', () => {
        el.value = formatPhone(unformatPhone(el.value));
      });
    })();

    function getSelectedServices() {
      return Array.from(document.querySelectorAll('.svc-chk'))
        .filter(chk => chk.checked)
        .map(chk => chk.value);
    }

    function visitsLeft(total, every = 5) {
      const t = Number(total || 0);
      const r = t % every;
      return r === 0 ? every : every - r;
    }

    function buildPayloadFromForm() {
      const rawPhone = $('phone').value;
      const phoneDigits = unformatPhone(rawPhone);

      // Only include profile fields if extra-fields are visible (i.e., new guest flow)
      const isExtraVisible = !$('extra-fields').classList.contains('hidden');

      return {
        submissionId: genId(),
        phone: phoneDigits,
        services: getSelectedServices(),
        name: isExtraVisible ? ($('fullName').value.trim() || undefined) : undefined,
        email: isExtraVisible ? ($('email').value.trim() || undefined) : undefined,
        birthday: isExtraVisible ? ($('birthday').value || undefined) : undefined, // 'YYYY-MM-DD'
        smsOptin: isExtraVisible ? ($('smsOptin').checked === true) : undefined
      };
    }

    async function submitCheckin(payload) {
      const resp = await fetch(ENDPOINT, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
      });
      if (!resp.ok) {
        const text = await resp.text().catch(() => '');
        throw new Error(text || `Request failed: ${resp.status}`);
      }
      return resp.json();
    }

    function showResultCard(data, guestName) {
      $('form-fields')?.classList.add('hidden');
      $('checkin-btn')?.classList.add('hidden');

      const total = Number(data?.totalVisits || 0);
      const left = (typeof data?.visitsLeft === 'number')
        ? data.visitsLeft
        : visitsLeft(total, 5);

      const title = data?.message || `Thanks for checking in${guestName ? `, ${guestName}` : ''}!`;
      $('result-title').textContent = title;

      const sub = data?.hasReward
        ? `üéâ You unlocked a reward today: Free Eyebrows!`
        : `${left} visit${left === 1 ? '' : 's'} left before your next reward (Free Eyebrows).`;
      $('result-sub').textContent = sub;

      const servicesText = Array.isArray(data?.services) && data.services.length
        ? data.services.join(', ')
        : '‚Äî';
      $('result-services').textContent = servicesText;

      if (data?.hasReward && data?.reward) {
        $('result-reward').classList.remove('hidden');
        $('result-reward-text').textContent =
          data.reward.reason ? data.reward.reason : 'Reward earned';
      } else {
        $('result-reward').classList.add('hidden');
      }

      $('result-cashier-note').textContent =
        data?.cashierNote || 'Show reward code at checkout if present.';

      $('result-card').classList.remove('hidden');
    }

    function revealExtraFields() {
      $('extra-fields').classList.remove('hidden');
      setTimeout(() => $('fullName').focus(), 50);
    }

    function resetForNextGuest() {
      $('checkin-form').reset();
      $('phone').value = '';
      setBanner('');
      $('extra-fields').classList.add('hidden');
      $('form-fields')?.classList.remove('hidden');
      $('checkin-btn')?.classList.remove('hidden');
      $('result-card')?.classList.add('hidden');
      document.querySelectorAll('.svc-chk').forEach(chk => chk.checked = false);
    }

    // -----------------------------
    // Submit handler
    // -----------------------------
    async function handleSubmit(e) {
      e.preventDefault();

      const btn = $('checkin-btn');
      btn.disabled = true;
      const original = btn.textContent;
      btn.textContent = 'Checking in‚Ä¶';

      try {
        const payload = buildPayloadFromForm();

        if (!payload.phone || payload.phone.length !== 10) {
          throw new Error('Please enter a valid 10-digit phone number.');
        }

        const data = await submitCheckin(payload);

        if (data?.success) {
          const guestName = $('fullName').value.trim();
          setBanner(`Thanks for checking in${guestName ? `, ${guestName}` : ''}!`, 'ok');
          showResultCard(data, guestName);
        } else if (data?.needsProfile) {
          // New customer flow: reveal name/birthday/email/sms, keep services
          revealExtraFields();
          setBanner(data?.message || 'We couldn‚Äôt verify your phone ‚Äî please add your name and birthday, then tap Check In again.', 'ok');
        } else {
          setBanner('Something went wrong. Please try again.', 'error');
        }
      } catch (err) {
        console.error(err);
        setBanner(err?.message || 'Network or server error. Please try again.', 'error');
      } finally {
        btn.disabled = false;
        btn.textContent = original;
      }
    }
  </script>
</body>
</html>
