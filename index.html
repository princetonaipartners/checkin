<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Salon Check-In</title>
  <style>
    :root{
      --bg:#f5f6fb; --card:#fff; --brand1:#6c63ff; --brand2:#7c49ff;
      --text:#222; --muted:#666; --ok:#0a7c2f; --warn:#b85c00; --err:#b00020;
    }
    html,body{height:100%}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      background: radial-gradient(1200px 600px at 15% -10%, #9fa8ff 0, #7b83ff 30%, #6c63ff 55%, #544eff 70%, #3f3cff 100%) no-repeat;
      color:var(--text);
    }
    .wrap{display:grid;place-items:center;min-height:100%;padding:32px 16px}
    .card{
      width:100%;max-width:640px;background:#fff;border-radius:16px;
      box-shadow:0 20px 35px rgba(35,40,105,.25);padding:28px
    }
    h1{margin:0 0 6px;font-size:32px}
    .sub{color:var(--muted);margin:0 0 18px;font-size:14px}
    .form-group{margin:14px 0 12px}
    label{display:block;font-weight:600;margin-bottom:6px}
    input[type="text"],input[type="tel"],input[type="email"],input[type="date"]{
      width:100%;padding:14px 16px;border-radius:12px;border:1px solid #d8daf3;background:#fdfdff;font-size:16px;outline:none
    }
    input:focus{border-color:#b1b6ff;box-shadow:0 0 0 3px rgba(108,99,255,.12)}
    .services{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
    .svc{display:flex;align-items:center;gap:10px;border:1px solid #e2e5ff;border-radius:12px;padding:12px 14px;background:#fff;user-select:none}
    .btn{
      display:block;width:100%;margin-top:14px;background:linear-gradient(90deg,var(--brand1),var(--brand2));
      color:#fff;border:0;border-radius:12px;padding:14px 18px;font-size:18px;font-weight:700;cursor:pointer;
      box-shadow:0 8px 18px rgba(108,99,255,.35)
    }
    .message{margin:12px 0 0;padding:10px 12px;border-radius:10px;font-size:14px;display:none}
    .message.info{display:block;background:#eef0ff;color:#2f36a3}
    .message.ok{display:block;background:#eaf6ee;color:#0a7c2f}
    .message.err{display:block;background:#fcecef;color:#b00020}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .hide{display:none !important}
    .optin-row{display:flex;align-items:center;gap:10px;margin-top:12px;color:#555}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>‚ú® Welcome to Our Salon</h1>
      <p class="sub">Quick &amp; Easy Check-in</p>

      <div id="message" class="message"></div>

      <form id="checkinForm" novalidate>
        <div class="form-group">
          <label for="phone">üì± Phone Number *</label>
          <input type="tel" id="phone" inputmode="numeric" autocomplete="tel" placeholder="(555) 123-4567" required />
        </div>

        <!-- Shown only when number is NEW -->
        <div id="additionalFields" class="hide">
          <div class="form-group">
            <label for="name">üë§ Full Name *</label>
            <input type="text" id="name" placeholder="Jane Doe" />
          </div>

          <div class="row">
            <div class="form-group">
              <label for="email">üìß Email (Optional)</label>
              <input type="email" id="email" placeholder="jane@example.com" />
            </div>

            <div class="form-group">
              <label for="birthday">üéÇ Birthday *</label>
              <input type="date" id="birthday" placeholder="YYYY-MM-DD" />
              <small style="color:#666;display:block;margin-top:6px;">We‚Äôll send you a birthday reward.</small>
            </div>
          </div>
        </div>

        <div class="form-group" style="margin-top:16px;">
          <label>What services are you here for today?</label>
          <div class="services">
            <label class="svc"><input type="checkbox" name="services" value="Hair" />üíá‚Äç‚ôÄÔ∏è Hair</label>
            <label class="svc"><input type="checkbox" name="services" value="Makeup" />üíÑ Makeup</label>
            <label class="svc"><input type="checkbox" name="services" value="Eyebrows" />üëÅÔ∏è Eyebrows</label>
            <label class="svc"><input type="checkbox" name="services" value="Nails" />üíÖ Nails</label>
            <label class="svc"><input type="checkbox" name="services" value="Facial" />üßñ Facial</label>
            <label class="svc"><input type="checkbox" name="services" value="Other" />‚ú® Other</label>
          </div>
        </div>

        <!-- SMS opt-in moved to the very bottom; appears only for NEW customers -->
        <label id="smsRow" class="optin-row hide">
          <input type="checkbox" id="smsOptin" />
          <span>üì± Send me exclusive offers &amp; rewards via SMS</span>
        </label>

        <button id="submitBtn" class="btn" type="submit">Check In</button>
      </form>
    </div>
  </div>

  <script>
    // === CONFIG: test endpoints ===
    const LOOKUP_URL  = 'https://princetonai.app.n8n.cloud/webhook-test/ai-lookup';
    const CHECKIN_URL = 'https://princetonai.app.n8n.cloud/webhook-test/ai-checkin';

    // === Helpers ===
    const $ = sel => document.querySelector(sel);
    function show(el){ el.classList.remove('hide'); }
    function hide(el){ el.classList.add('hide'); }
    function onlyDigits(s){ return (s||'').replace(/\D/g,''); }
    function uuid(){ return ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,c=>(c^crypto.getRandomValues(new Uint8Array(1))[0]&15>>c/4).toString(16)); }
    function showMessage(txt,type='info'){ const m=$('#message'); m.className=`message ${type}`; m.textContent=txt; m.style.display='block'; }

    // ===== Phone formatter with caret preservation =====
    function formatFromDigits(d){
      if (d.length <= 3) return d;
      if (d.length <= 6) return `(${d.slice(0,3)}) ${d.slice(3)}`;
      return `(${d.slice(0,3)}) ${d.slice(3,6)}-${d.slice(6,10)}`;
    }
    function posForDigitIndex(formatted, digitIdx){
      if (digitIdx <= 0) return 0;
      let count=0;
      for (let i=0;i<formatted.length;i++){
        if (/\d/.test(formatted[i])) count++;
        if (count === digitIdx) return i+1;
      }
      return formatted.length;
    }

    const phoneInput = $('#phone');
    let prevVal = '';
    let prevCaret = 0;

    phoneInput.addEventListener('keydown', () => {
      prevVal = phoneInput.value;
      prevCaret = phoneInput.selectionStart || 0;
    });

    phoneInput.addEventListener('input', () => {
      const digitsLeft = onlyDigits(prevVal.slice(0, prevCaret)).length;
      const allDigits = onlyDigits(phoneInput.value).slice(0,10);
      const formatted = formatFromDigits(allDigits);
      const newPos = posForDigitIndex(formatted, digitsLeft + (allDigits.length > onlyDigits(prevVal).length ? 1 : 0));
      phoneInput.value = formatted;
      const pos = Math.min(newPos, formatted.length);
      phoneInput.setSelectionRange(pos, pos);
      prevVal = formatted;
      prevCaret = pos;
    });
    // ===== end phone formatter =====

    // === Elements & state ===
    const form = $('#checkinForm');
    const submitBtn = $('#submitBtn');
    const addl = $('#additionalFields');
    const nameInput = $('#name');
    const emailInput = $('#email');
    const birthdayInput = $('#birthday');
    const smsRow = $('#smsRow');
    const smsOptinInput = $('#smsOptin');

    let awaitingExtra = false; // two-step when new

    // Submit flow
    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      const digits = onlyDigits(phoneInput.value);
      if (digits.length !== 10) {
        showMessage('Please enter a valid 10-digit phone number.', 'err');
        phoneInput.focus(); return;
      }

      const services = Array.from(document.querySelectorAll('input[name="services"]:checked')).map(i=>i.value);
      if (services.length === 0) {
        showMessage('Please select at least one service.', 'err'); return;
      }

      // STEP 1: lookup on first click
      if (!awaitingExtra) {
        try {
          showMessage('Checking your profile‚Ä¶', 'info');
          const r = await fetch(LOOKUP_URL, {
            method:'POST', headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ phone: digits })
          });
          if (!r.ok) throw new Error('Lookup failed');
          const data = await r.json();

          if (data && data.exists) {
            // Returning customer: submit immediately
            await submitCheckin({ digits, services });
            return;
          } else {
            // New customer ‚Üí show fields + SMS opt-in at bottom
            awaitingExtra = true;
            submitBtn.textContent = 'Finish Check-In';
            show(addl);
            show(smsRow);
            nameInput.required = true;
            birthdayInput.required = true;
            showMessage('We could not verify your phone automatically‚Äîplease add your name and birthday.', 'info');
            return;
          }
        } catch(err){
          console.error(err);
          // Fallback: treat as new
          awaitingExtra = true;
          submitBtn.textContent = 'Finish Check-In';
          show(addl);
          show(smsRow);
          nameInput.required = true;
          birthdayInput.required = true;
          showMessage('We could not verify your phone automatically‚Äîplease add your name and birthday.', 'warn');
          return;
        }
      }

      // STEP 2: validate & submit for new customer
      if (awaitingExtra) {
        if (!nameInput.value.trim()) { showMessage('Please enter your full name.', 'err'); nameInput.focus(); return; }
        if (!birthdayInput.value)     { showMessage('Please select your birthday.', 'err'); birthdayInput.focus(); return; }
        await submitCheckin({
          digits,
          services,
          name: nameInput.value.trim(),
          email: emailInput.value ? emailInput.value.trim() : null,
          birthday: birthdayInput.value,
          smsOptin: !!smsOptinInput.checked
        });
      }
    });

    async function submitCheckin({digits, services, name=null, email=null, birthday=null, smsOptin=false}){
      const payload = {
        submissionId: uuid(),
        phone: digits,
        services,
        name, email, birthday,
        smsOptin
      };

      try{
        showMessage('Submitting your check-in‚Ä¶', 'info');
        const res = await fetch(CHECKIN_URL, {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify(payload)
        });

        // Try JSON; fall back to text
        let msg = '';
        let data = null;
        try { data = await res.json(); } catch { msg = await res.text(); }
        if (!res.ok) throw new Error(msg || 'Check-in failed');

        let success = 'Thanks for checking in!';
        if (payload.name) success = `Thanks for checking in, ${payload.name.split(' ')[0]}!`;
        if (data && data.hasReward && data.reward) {
          const desc = data.reward.type === 'percent_off' ? `${data.reward.value}% off` : `$${data.reward.value} off`;
          success += ` üéâ Reward: ${desc} ‚Äî Code: ${data.reward.code}`;
        }
        showMessage(success, 'ok');

        // Reset state
        awaitingExtra = false;
        submitBtn.textContent = 'Check In';
        hide(addl); hide(smsRow);
        nameInput.required = false; birthdayInput.required = false;
        nameInput.value=''; emailInput.value=''; birthdayInput.value=''; smsOptinInput.checked=false;
        document.querySelectorAll('input[name="services"]').forEach(i=>i.checked=false);
      }catch(err){
        console.error(err);
        showMessage('Something went wrong while checking you in. Please try again.', 'err');
      }
    }
  </script>
</body>
</html>
