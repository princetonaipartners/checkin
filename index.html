<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Welcome to Our Salon ‚Äî Check-In</title>
  <style>
    :root{
      --bg: #f6f5ff;
      --card: #ffffff;
      --ink: #171717;
      --muted:#636363;
      --hint:#8a8a8a;
      --primary:#6c47ff;
      --primary-900:#5d3de3;
      --ring:#eae7ff;
      --ok:#eaf7ef;
      --ok-ink:#1f7a3e;
      --warn:#fff3f0;
      --warn-ink:#8a3c32;
      --soft:#f7f8ff;
    }
    html,body{margin:0;padding:0;background:
      radial-gradient(1000px 600px at 10% 0%, #a089ff 0%, transparent 60%),
      radial-gradient(1000px 600px at 90% 0%, #caa8ff 0%, transparent 60%),
      var(--bg);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      color:var(--ink);
    }
    .wrap{max-width:860px;margin:32px auto;padding:24px}
    .card{background:var(--card); border-radius:18px; box-shadow:0 8px 30px rgba(40,30,90,.08); padding:28px}
    h1{font-size:38px; line-height:1.15; margin:0 0 6px}
    .lead{color:var(--muted); margin-bottom:18px}
    .row{display:grid; grid-template-columns:1fr 1fr; gap:14px}
    .full{grid-column:1/-1}
    label{display:block; font-weight:600; margin:14px 0 8px}
    .subtle{font-weight:500; color:var(--hint); margin-top:6px}
    input[type="text"], input[type="email"], input[type="date"]{
      width:100%; font-size:16px; padding:12px 14px; border-radius:12px; border:1px solid #e3e3ef; outline:0;
      transition:border-color .15s, box-shadow .15s; background:#fff;
    }
    input[type="text"]:focus, input[type="email"]:focus, input[type="date"]:focus{
      border-color:#cfcafc; box-shadow:0 0 0 3px var(--ring);
    }
    .alert{padding:12px 14px; border-radius:12px; margin-bottom:18px; display:none}
    .alert.ok{display:block; background:var(--ok); color:var(--ok-ink)}
    .alert.warn{display:block; background:var(--warn); color:var(--warn-ink)}
    .pill{display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border:1px solid #ecebff; border-radius:12px; cursor:pointer; user-select:none; background:var(--soft)}
    .pill input{width:18px;height:18px}
    .grid-3{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    @media(min-width:720px){.grid-3{grid-template-columns:repeat(3,1fr)}}
    .cta{display:block; width:100%; margin-top:18px; border:0; color:#fff; font-weight:700; font-size:18px; padding:16px 18px; border-radius:14px; cursor:pointer; background:linear-gradient(90deg, var(--primary), #7a5bff)}
    .cta:hover{background:linear-gradient(90deg, var(--primary-900), #6c47ff)}
    .divider{height:1px; background:#efeefe; margin:16px 0}
    .hidden{display:none !important}
    .summary{background:#fbfbff;border:1px solid #ecebff;border-radius:14px;padding:18px}
    .summary b{font-weight:700}
    .note{color:var(--muted); font-style:italic; margin-top:8px}
    .banner{padding:12px 14px; border-radius:12px; background:#f2f6ff; border:1px solid #e6ebff; color:#324071; margin:10px 0 0}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Welcome to Our Salon</h1>
      <div class="lead">Quick &amp; Easy Check-in</div>

      <!-- alerts -->
      <div id="alert" class="alert"></div>

      <!-- summary -->
      <div id="summaryBox" class="summary hidden">
        <div id="thanksLine" style="font-weight:800; font-size:18px; margin-bottom:8px;">Thanks for checking in!</div>
        <div id="rewardLine" style="margin-bottom:8px;"></div>
        <div><b>Services today:</b> <span id="servicesToday">‚Äî</span></div>
        <div class="note" id="cashierNote">Show reward code at checkout if present.</div>
        <button class="cta" id="doneBtn" style="margin-top:16px">Done</button>
      </div>

      <!-- form -->
      <form id="checkinForm" class="hidden">
        <!-- profile banner (only visible when we need profile) -->
        <div id="profileBanner" class="banner hidden">
          We couldn't verify your profile automatically ‚Äî please add your <b>name</b> and <b>birthday</b>.
        </div>

        <!-- phone -->
        <div class="full">
          <label for="phone">üìû Phone Number *</label>
          <input id="phone" name="phone" type="text" inputmode="numeric" autocomplete="tel" placeholder="(123) 456-7890" />
          <div class="subtle">We use this to find your profile and reward progress.</div>
        </div>

        <!-- profile fields (hidden on first submit) -->
        <div id="profileFields" class="row hidden" aria-hidden="true">
          <div>
            <label for="name">üë§ Full Name *</label>
            <input id="name" name="name" type="text" placeholder="Jane Doe" />
          </div>
          <div>
            <label for="email">‚úâÔ∏è Email (Optional)</label>
            <input id="email" name="email" type="email" placeholder="jane@example.com" />
          </div>
          <div class="full">
            <label for="birthday">üéÇ Birthday *</label>
            <input id="birthday" name="birthday" type="date" />
            <div class="subtle">You'll get a birthday reward üéâ</div>
          </div>

          <div class="full">
            <label class="pill">
              <input id="smsOptin" type="checkbox" />
              <span>üì± Send me exclusive offers &amp; rewards via SMS</span>
            </label>
            <div class="subtle">We‚Äôll only text about rewards and salon offers.</div>
          </div>
        </div>

        <div class="divider"></div>

        <!-- services -->
        <label class="full">What services are you here for today?</label>
        <div class="grid-3">
          <label class="pill"><input type="checkbox" class="svc" value="Hair" /> üíá‚Äç‚ôÄÔ∏è Hair</label>
          <label class="pill"><input type="checkbox" class="svc" value="Makeup" /> üíÑ Makeup</label>
          <label class="pill"><input type="checkbox" class="svc" value="Eyebrows" /> üëÅÔ∏è Eyebrows</label>
          <label class="pill"><input type="checkbox" class="svc" value="Nails" /> üíÖ Nails</label>
          <label class="pill"><input type="checkbox" class="svc" value="Facial" /> ‚ú® Facial</label>
          <label class="pill"><input type="checkbox" class="svc" value="Other" /> ‚ú® Other</label>
        </div>

        <button id="submitBtn" class="cta">Check In</button>
      </form>
    </div>
  </div>

  <script>
    // ---------- CONFIG ----------
    const WEBHOOK_URL = 'https://princetonai.app.n8n.cloud/webhook-test/ai-checkin';

    // ---------- STATE ----------
    let submissionId = null;   // visit/session id from backend
    let profileMode   = false; // true after backend asks for profile
    let lastServices  = [];    // keep selected services between steps

    // ---------- ELEMENTS ----------
    const alertBox      = document.getElementById('alert');
    const form          = document.getElementById('checkinForm');
    const submitBtn     = document.getElementById('submitBtn');
    const profileFields = document.getElementById('profileFields');
    const profileBanner = document.getElementById('profileBanner');
    const phoneInput    = document.getElementById('phone');
    const nameInput     = document.getElementById('name');
    const emailInput    = document.getElementById('email');
    const birthdayInput = document.getElementById('birthday');
    const smsOptin      = document.getElementById('smsOptin');
    const svcBoxes      = Array.from(document.querySelectorAll('.svc'));
    const summaryBox    = document.getElementById('summaryBox');
    const thanksLine    = document.getElementById('thanksLine');
    const rewardLine    = document.getElementById('rewardLine');
    const servicesToday = document.getElementById('servicesToday');
    const cashierNote   = document.getElementById('cashierNote');
    const doneBtn       = document.getElementById('doneBtn');

    // ---------- INIT ----------
    form.classList.remove('hidden');

    // smooth phone formatting while typing
    phoneInput.addEventListener('input', (e) => {
      const pos = e.target.selectionStart;
      const before = e.target.value;
      e.target.value = formatPhone(before);
      // try to keep caret sensible
      const delta = e.target.value.length - before.length;
      e.target.setSelectionRange(pos + (delta>0?1:0), pos + (delta>0?1:0));
    });

    form.addEventListener('submit', onSubmit);
    doneBtn.addEventListener('click', () => {
      // simple UX: scroll to top or reset
      window.scrollTo({top:0, behavior:'smooth'});
    });

    // ---------- HELPERS ----------
    function showAlert(kind, msg){
      alertBox.className = 'alert ' + (kind === 'ok' ? 'ok' : 'warn');
      alertBox.textContent = msg;
      alertBox.style.display = 'block';
    }
    function clearAlert(){
      alertBox.style.display = 'none';
    }
    function formatPhone(v){
      let d = (v || '').replace(/\D/g,'');
      if (d.length > 11) d = d.slice(0,11);
      if (d.length === 11 && d.startsWith('1')) d = d.slice(1);
      if (d.length <= 3) return d ? '(' + d : '';
      if (d.length <= 6) return '(' + d.slice(0,3) + ') ' + d.slice(3);
      return '(' + d.slice(0,3) + ') ' + d.slice(3,6) + '-' + d.slice(6,10);
    }
    function normalizePhone(v){
      let d = (v || '').replace(/\D/g,'');
      if (d.length === 11 && d.startsWith('1')) d = d.slice(1);
      return d.slice(0,10);
    }
    function getSelectedServices(){
      return svcBoxes.filter(x => x.checked).map(x => x.value);
    }
    function getBirthdayISO(){
      const v = birthdayInput.value;       // if input[type=date], browser gives yyyy-mm-dd already
      if (!v) return '';
      // Ensure yyyy-mm-dd
      const m = /^(\d{4})-(\d{2})-(\d{2})$/.exec(v);
      if (m) return v;
      // If user typed mm/dd/yyyy
      const m2 = /^(\d{2})\/(\d{2})\/(\d{4})$/.exec(v);
      if (m2) return `${m2[3]}-${m2[1]}-${m2[2]}`;
      return v;
    }
    function toggleProfileMode(on){
      profileMode = !!on;
      profileFields.classList.toggle('hidden', !on);
      profileFields.setAttribute('aria-hidden', on ? 'false':'true');
      profileBanner.classList.toggle('hidden', !on);
      submitBtn.textContent = on ? 'Save & Check In' : 'Check In';
    }
    function renderSummary(data){
      const svcs = Array.isArray(data.services) ? data.services : lastServices;
      const total = Number(data.totalVisits ?? 0) || 0;
      const hasReward = !!data.hasReward;
      const reward = data.reward || null;

      // visits left until next 5th
      let left = 5 - (total % 5);
      if (left === 5) left = 0;

      thanksLine.textContent = data.message || 'Thanks for checking in!';
      if (hasReward && reward) {
        // assuming your reward is Free Eyebrows on every 5th
        rewardLine.textContent = 'üéâ You earned a free Eyebrows today!';
      } else {
        rewardLine.textContent = `${left || 5} visits left before your next reward (Free Eyebrows).`;
      }
      servicesToday.textContent = svcs && svcs.length ? svcs.join(', ') : '‚Äî';
      cashierNote.textContent = data.cashierNote || 'Show reward code at checkout if present.';

      summaryBox.classList.remove('hidden');
      form.classList.add('hidden');
      clearAlert();
    }

    // ---------- SUBMIT FLOW ----------
    async function onSubmit(e){
      e.preventDefault();
      clearAlert();

      const phone = normalizePhone(phoneInput.value);
      if (phone.length !== 10) {
        showAlert('warn','Please enter a valid 10-digit phone number.');
        phoneInput.focus();
        return;
      }

      // Collect services first (both steps)
      const services = getSelectedServices();
      if (!services.length) {
        showAlert('warn','Please choose at least one service.');
        return;
      }
      lastServices = services.slice();

      // Prepare payload
      const body = {
        phone,
        services
      };

      if (profileMode) {
        body.submissionId = submissionId;
        body.name     = (nameInput.value || '').trim();
        body.email    = (emailInput.value || '').trim();
        body.birthday = getBirthdayISO();
        body.smsOptin = !!smsOptin.checked;

        if (!body.name)    { showAlert('warn','Please enter your full name.'); return; }
        if (!body.birthday){ showAlert('warn','Please enter your birthday.'); return; }
      } else {
        // first pass can include smsOptin if you prefer to collect it early; requested to ask in profile step, so not sending here
      }

      submitBtn.disabled = true;
      submitBtn.textContent = profileMode ? 'Saving‚Ä¶' : 'Checking in‚Ä¶';

      try{
        const res = await fetch(WEBHOOK_URL, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify(body)
        });

        if (!res.ok) {
          const t = await res.text().catch(()=> '');
          throw new Error(t || 'Network error');
        }

        const data = await res.json();

        // Branch: backend asks for profile
        if (data && data.askProfile) {
          submissionId = data.submissionId || submissionId;
          toggleProfileMode(true);
          showAlert('ok', data.message || 'Please add your name & birthday.');
          // keep phone & services as they are, allow edits if needed
          return;
        }

        // Otherwise, final summary from Respond Done
        if (data && data.success) {
          renderSummary(data);
          return;
        }

        // If we reach here, show any message we have
        showAlert('warn', (data && data.message) || 'Unexpected response. Please try again.');
      } catch(err){
        console.error(err);
        showAlert('warn', 'Failed to fetch');
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = profileMode ? 'Save & Check In' : 'Check In';
      }
    }
  </script>
</body>
</html>
