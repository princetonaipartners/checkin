<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, maximum-scale=1"
  />
  <title>Welcome to Our Salon — Quick Check-in</title>
  <style>
    :root{
      --bg1:#7b5cff;
      --bg2:#a78bfa;
      --card:#ffffff;
      --text:#111827;
      --muted:#6b7280;
      --ok:#e8f7ee;
      --okText:#036757;
      --err:#ffecec;
      --errText:#991b1b;
      --accent:#6d28d9;
      --accent2:#8b5cf6;
      --ring:#e9d5ff;
      --shadow:0 20px 40px rgba(0,0,0,.08);
    }
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";
      background: radial-gradient(1200px 800px at 10% 10%, var(--bg2), transparent),
                  radial-gradient(1400px 900px at 90% 0%, var(--bg1), transparent),
                  #f8fafc;
      color:var(--text);
    }
    .wrap{
      max-width: 920px;
      margin: 24px auto;
      padding: 0 16px;
    }
    .card{
      background:var(--card);
      border-radius:20px;
      box-shadow: var(--shadow);
      padding: 28px 28px 32px;
    }
    h1{
      font-size: clamp(28px, 3.6vw, 40px);
      letter-spacing:.3px;
      margin: 0 0 6px;
    }
    .sub{color:var(--muted); margin-bottom: 18px}

    .row{display:grid; grid-template-columns:1fr 1fr; gap:16px}
    @media (max-width: 720px){ .row{grid-template-columns:1fr} }

    label.lbl{
      display:block;
      font-weight:600;
      margin: 14px 0 6px;
    }
    .field{
      display:flex;align-items:center;gap:10px;
      border:1px solid #e5e7eb;
      border-radius:12px;
      padding:12px 14px;
      background:#fff;
      outline:none;
      width:100%;
      transition: box-shadow .15s, border-color .15s;
    }
    .field:focus-within{
      border-color:var(--accent2);
      box-shadow:0 0 0 4px var(--ring);
    }
    input[type="text"], input[type="email"], input[type="date"]{
      border:0;outline:0;font-size:16px;flex:1;min-width:0;background:transparent;
    }

    .services{
      display:grid;grid-template-columns:1fr 1fr; gap:14px;
      margin-top:8px;
    }
    @media (max-width:720px){ .services{grid-template-columns:1fr} }
    .svc{
      border:1px solid #e5e7eb;border-radius:12px;padding:14px 14px;
      display:flex;align-items:center; gap:10px;
      background:#fff;
    }
    .svc input{width:18px;height:18px}
    .muted{color:var(--muted); font-size:14px}

    .row.optin{
      grid-template-columns: 1fr;
    }
    .optincard{
      border:1px dashed #e5e7eb;border-radius:12px;padding:14px;
      display:flex;gap:10px;align-items:center;background:#fff;
    }

    .btn{
      display:block; width:100%;
      background: linear-gradient(90deg, var(--accent), var(--accent2));
      color:#fff;font-weight:700; letter-spacing:.3px;
      border:0;border-radius:14px; padding:16px 18px; margin-top:20px;
      box-shadow: 0 8px 24px rgba(109,40,217,.25);
      transition: transform .06s ease-in-out, filter .15s;
      cursor:pointer;
    }
    .btn:active{ transform: translateY(1px) }
    .btn[disabled]{ opacity:.7; filter:grayscale(.15); cursor:not-allowed }

    .banner{
      border-radius:12px; padding:12px 14px; margin:12px 0 18px; display:none;
      font-weight:600;
    }
    .banner.ok{ display:block; background: var(--ok); color: var(--okText) }
    .banner.err{ display:block; background: var(--err); color: var(--errText) }

    .hidden{ display:none !important }

    /* Result Card */
    .result{
      margin-top:14px; padding:18px; border-radius:16px;
      background: linear-gradient(180deg,#fbfbff,#f7f6ff);
      border:1px solid #ebe7ff;
    }
    .result h3{ margin:0 0 8px; font-size:20px }
    .result .muted{ font-style: italic }
    .donebtn{ margin-top:16px }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Welcome to Our Salon</h1>
      <div class="sub">Quick &amp; Easy Check-in</div>

      <div id="banner" class="banner"></div>

      <form id="form" novalidate>
        <!-- Phone -->
        <label class="lbl" for="phone">📞 Phone Number *</label>
        <div class="field">
          <input id="phone" type="text" inputmode="numeric" autocomplete="tel" placeholder="(123) 456-7890" maxlength="14" />
        </div>
        <div class="muted" style="margin-top:6px">We’ll use this to find your profile and reward progress.</div>

        <!-- Extra fields: only shown if needsProfile=true -->
        <div id="extra-fields" class="hidden">
          <div class="row">
            <div>
              <label class="lbl" for="fullName">👤 Full Name *</label>
              <div class="field"><input id="fullName" type="text" placeholder="Jane Doe" /></div>
            </div>
            <div>
              <label class="lbl" for="email">✉️ Email (Optional)</label>
              <div class="field"><input id="email" type="email" placeholder="jane@example.com" /></div>
            </div>
          </div>

          <label class="lbl" for="birthday">🎂 Birthday *</label>
          <div class="field" style="max-width:420px">
            <input id="birthday" type="date" />
          </div>
          <div class="muted" style="margin-top:6px">You’ll get a birthday reward 🎉</div>

          <div class="row optin">
            <label class="optincard" for="smsOptin">
              <input id="smsOptin" type="checkbox" />
              <div>
                <div><strong>Send me exclusive offers &amp; rewards via SMS</strong></div>
                <div class="muted">We’ll only text about rewards and salon offers.</div>
              </div>
            </label>
          </div>
        </div>

        <!-- Services -->
        <label class="lbl" style="margin-top:18px">What services are you here for today?</label>
        <div class="services">
          <label class="svc"><input type="checkbox" value="Hair" /> 💇 Hair</label>
          <label class="svc"><input type="checkbox" value="Makeup" /> 💄 Makeup</label>
          <label class="svc"><input type="checkbox" value="Eyebrows" /> 👁️ Eyebrows</label>
          <label class="svc"><input type="checkbox" value="Nails" /> 💅 Nails</label>
          <label class="svc"><input type="checkbox" value="Facial" /> 💆 Facial</label>
          <label class="svc"><input type="checkbox" value="Other" /> ✨ Other</label>
        </div>

        <button id="checkin-btn" class="btn" type="submit">Check In</button>
      </form>

      <!-- RESULT -->
      <div id="result-wrap" class="hidden">
        <div class="result" id="result-card">
          <!-- filled dynamically -->
        </div>
        <button class="btn donebtn" id="done-btn">Done</button>
      </div>
    </div>
  </div>

  <script>
    // ───────────────────────────
    // Config
    // ───────────────────────────
    const ENDPOINT = "https://princetonai.app.n8n.cloud/webhook-test/ai-checkin";

    // ───────────────────────────
    // Utilities
    // ───────────────────────────
    const $ = (id) => document.getElementById(id);
    function setBanner(msg, type = "ok") {
      const el = $("banner");
      if (!msg) { el.style.display = "none"; el.textContent = ""; return; }
      el.className = "banner " + (type === "error" || type === "err" ? "err" : "ok");
      el.textContent = msg;
      el.style.display = "block";
    }
    function genId(){
      const t = Date.now().toString(36), r = Math.random().toString(36).slice(2, 8);
      return `v${t}${r}`;
    }
    function getSelectedServices(){
      const labels = document.querySelectorAll(".services .svc input[type='checkbox']");
      const out = [];
      labels.forEach(c => { if (c.checked) out.push(c.value); });
      return out;
    }
    function visitsLeftToFive(total) {
      if (typeof total !== 'number' || isNaN(total) || total < 0) return null;
      const mod = total % 5;
      return mod === 0 ? 5 : (5 - mod);
    }

    // Phone mask – caret-safe, appends formatting without eating digits
    const phoneInput = $("phone");
    phoneInput.addEventListener("input", (e) => {
      const start = phoneInput.selectionStart;
      const prev = phoneInput.value;
      const digits = prev.replace(/\D/g, "").slice(0, 10);
      let out = digits;
      if (digits.length > 6) {
        out = `(${digits.slice(0,3)}) ${digits.slice(3,6)}-${digits.slice(6)}`;
      } else if (digits.length > 3) {
        out = `(${digits.slice(0,3)}) ${digits.slice(3)}`;
      } else if (digits.length > 0) {
        out = `(${digits}`;
      }
      phoneInput.value = out;
      // place caret at end (simple + robust for numeric typing)
      phoneInput.setSelectionRange(phoneInput.value.length, phoneInput.value.length);
    });

    // ───────────────────────────
    // Submission helpers
    // ───────────────────────────
    function buildPayloadFromForm(){
      const rawPhone = $("phone").value;
      const phoneDigits = (rawPhone || "").replace(/\D/g, "").slice(0, 10);
      const showExtra = !$("extra-fields").classList.contains("hidden");
      return {
        submissionId: genId(),
        phone: phoneDigits,
        services: getSelectedServices(),
        name:     showExtra ? ($("fullName").value.trim() || undefined) : undefined,
        email:    showExtra ? ($("email").value.trim()     || undefined) : undefined,
        birthday: showExtra ? ($("birthday").value         || undefined) : undefined, // yyyy-mm-dd
        smsOptin: showExtra ? $("smsOptin").checked === true : undefined
      };
    }

    function revealExtraFields(){
      $("extra-fields").classList.remove("hidden");
      $("checkin-btn").textContent = "Save & Check In";
      setTimeout(() => $("fullName").focus(), 60);
    }

    function validateExtraFieldsIfShown(){
      const visible = !$("extra-fields").classList.contains("hidden");
      if (!visible) return true;
      const nm = $("fullName").value.trim();
      const bd = $("birthday").value;
      if (!nm) { setBanner("Please enter your full name.", "err"); $("fullName").focus(); return false; }
      if (!bd) { setBanner("Please select your birthday.", "err"); $("birthday").focus(); return false; }
      return true;
    }

    async function submitCheckin(payload){
      const res = await fetch(ENDPOINT, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });
      if (!res.ok) {
        const t = await res.text().catch(()=> "");
        throw new Error(t || "Server error");
      }
      return res.json();
    }

    function showResultCard(data, guestName){
      $("form").classList.add("hidden");
      const wrap = $("result-wrap");
      wrap.classList.remove("hidden");

      const svc = Array.isArray(data?.services) ? data.services : [];
      const svcLine = svc.length ? svc.join(", ") : "—";

      const visits = typeof data?.totalVisits === "number" ? data.totalVisits : null;
      const left = visitsLeftToFive(visits);
      const rewardName = "Free Eyebrows";

      const hasReward = !!data?.hasReward;
      const rewardLine = hasReward
        ? `<div class="muted">Reward unlocked: <strong>${rewardName}</strong>.</div>`
        : (left != null ? `<div class="muted">${left} visit${left === 1 ? "" : "s"} left before your next reward (${rewardName}).</div>` : "");

      const msg = (data?.message && data.message.trim()) || `Thanks for checking in${guestName ? ", " + guestName : ""}!`;

      $("result-card").innerHTML = `
        <h3>${msg}</h3>
        ${rewardLine}
        <p style="margin-top:12px"><strong>Services today:</strong> ${svcLine}</p>
        <div class="muted">${data?.cashierNote || "Show reward code at checkout if present."}</div>
      `;
    }

    function resetForNextGuest(){
      // reset form to initial state
      $("result-wrap").classList.add("hidden");
      $("form").classList.remove("hidden");
      setBanner("");

      $("phone").value = "";
      document.querySelectorAll(".services input[type='checkbox']").forEach(c => c.checked = false);

      $("extra-fields").classList.add("hidden");
      $("fullName").value = "";
      $("email").value = "";
      $("birthday").value = "";
      $("smsOptin").checked = false;

      $("checkin-btn").textContent = "Check In";
      $("phone").focus();
    }

    // ───────────────────────────
    // Submit handler
    // ───────────────────────────
    $("form").addEventListener("submit", async (e) => {
      e.preventDefault();
      const btn = $("checkin-btn");
      const original = btn.textContent;

      try{
        const digits = ($("phone").value || "").replace(/\D/g, "");
        if (digits.length !== 10) { throw new Error("Please enter a valid 10-digit phone number."); }

        if (!validateExtraFieldsIfShown()) return;

        btn.disabled = true; btn.textContent = "Checking in…";

        const payload = buildPayloadFromForm();
        const data = await submitCheckin(payload);

        // If backend says we need profile, do that first (never skip)
        if (data?.needsProfile) {
          revealExtraFields();
          setBanner(data?.message || "We couldn’t verify your phone — please add your name and birthday, then tap “Save & Check In”.", "ok");
          btn.disabled = false; btn.textContent = "Save & Check In";
          return;
        }

        // Real success → summary
        if (data?.success) {
          const guestName =
            (!$("extra-fields").classList.contains("hidden") ? $("fullName").value.trim() : "") || "";
          setBanner(`Thanks for checking in${guestName ? ", " + guestName : ""}!`, "ok");
          showResultCard(data, guestName);
        } else {
          setBanner("Something went wrong. Please try again.", "err");
        }

      } catch(err){
        console.error(err);
        setBanner(err?.message || "Network error. Please try again.", "err");
      } finally {
        // Keep "Save & Check In" if extra fields are visible
        const visible = !$("extra-fields").classList.contains("hidden");
        btn.disabled = false;
        btn.textContent = visible ? "Save & Check In" : original;
      }
    });

    $("done-btn").addEventListener("click", resetForNextGuest);
  </script>
</body>
</html>
