<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Welcome to Our Salon ‚Äî Quick Check-in</title>
  <style>
    :root{
      --bg: linear-gradient(180deg,#a78bfa 0%, #7c3aed 100%);
      --card:#ffffff;
      --muted:#6b7280;
      --ink:#111827;
      --ink-2:#374151;
      --brand:#6d28d9;
      --brand-2:#7c3aed;
      --brand-3:#8b5cf6;
      --success:#e8f6ee;
      --danger:#fde8e8;
      --ring: 0 0 0 4px rgba(124,58,237,.15)
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      color:var(--ink);
      background:var(--bg) fixed;
      min-height:100dvh;
      display:flex;align-items:flex-start;justify-content:center
    }
    .shell{
      width:min(940px,calc(100% - 24px));
      margin:26px 12px 40px;
      background:var(--card);
      border-radius:20px;
      box-shadow:0 20px 60px rgba(0,0,0,.15);
      padding:28px 28px 36px
    }
    h1{margin:4px 0 6px;font-weight:800;letter-spacing:.3px}
    .kicker{color:var(--muted);font-weight:600;margin-bottom:14px}
    .banner{
      border-radius:10px;padding:12px 14px;margin:10px 0 18px;font-weight:600
    }
    .ok{background:var(--success);color:#065f46}
    .warn{background:#eef2ff;color:#3730a3}
    .err{background:var(--danger);color:#7f1d1d}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    .control{margin:10px 0}
    label{display:block;font-size:.92rem;color:var(--ink-2);font-weight:700;margin:0 0 6px}
    input[type="text"],
    input[type="tel"],
    input[type="email"],
    input[type="date"]{
      width:100%;padding:14px 13px;border:1px solid #e5e7eb;border-radius:12px;
      font:inherit;background:#fff;outline:none;transition: box-shadow .15s,border-color .15s
    }
    input:focus{border-color:var(--brand-3);box-shadow:var(--ring)}
    .grid-services{
      display:grid;grid-template-columns:1fr 1fr;gap:12px;margin:4px 0 2px
    }
    .svc{
      display:flex;align-items:center;gap:10px;border:1px solid #e5e7eb;
      padding:12px 13px;border-radius:12px
    }
    .svc input{width:18px;height:18px}
    .muted{color:var(--muted);font-size:.9rem}
    .btn{
      width:100%;margin-top:16px;border:0;border-radius:14px;
      padding:16px 18px;color:#fff;background:linear-gradient(90deg,var(--brand) 0%,var(--brand-2) 100%);
      font-weight:800;letter-spacing:.3px;cursor:pointer
    }
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .hidden{display:none}
    .summary{
      border-radius:14px;background:#f6f7ff;border:1px solid #eef;
      padding:16px 16px 18px;margin:6px 0 16px
    }
    .summary h3{margin:0 0 6px}
    .center{text-align:center}
  </style>
</head>
<body>
  <main class="shell">
    <div class="kicker">Quick & Easy Check-in</div>
    <h1>Welcome to Our Salon</h1>

    <div id="alert" class="banner hidden"></div>

    <!-- FORM -->
    <form id="form" novalidate>
      <div id="needProfileMsg" class="banner warn hidden">
        We couldn't verify your profile automatically ‚Äî please add your <strong>name</strong> and <strong>birthday</strong>.
      </div>

      <div class="control">
        <label for="phone">üìû Phone Number *</label>
        <input id="phone" type="tel" inputmode="numeric" autocomplete="tel" placeholder="(123) 456-7890" maxlength="18" required>
        <div class="muted">We'll use this to find your profile and reward progress.</div>
      </div>

      <div id="profileFields" class="hidden">
        <div class="row">
          <div class="control">
            <label for="name">üë§ Full Name *</label>
            <input id="name" type="text" placeholder="Jane Doe">
          </div>
          <div class="control">
            <label for="email">‚úâÔ∏è Email (Optional)</label>
            <input id="email" type="email" placeholder="jane@example.com">
          </div>
        </div>

        <div class="row">
          <div class="control">
            <label for="birthday">üéÇ Birthday *</label>
            <input id="birthday" type="date">
            <div class="muted">You'll get a birthday reward üéâ</div>
          </div>
          <div class="control">
            <label> </label>
            <label class="svc" style="padding:14px 12px">
              <input id="sms" type="checkbox">
              <span>Send me exclusive offers & rewards via SMS</span>
            </label>
            <div class="muted">We‚Äôll only text about rewards and salon offers.</div>
          </div>
        </div>
      </div>

      <div class="control">
        <label>What services are you here for today?</label>
        <div class="grid-services" id="services">
          <label class="svc"><input type="checkbox" value="Hair"><span>üíá‚Äç‚ôÄÔ∏è Hair</span></label>
          <label class="svc"><input type="checkbox" value="Makeup"><span>üíÑ Makeup</span></label>
          <label class="svc"><input type="checkbox" value="Eyebrows"><span>üëÅÔ∏è Eyebrows</span></label>
          <label class="svc"><input type="checkbox" value="Nails"><span>üíÖ Nails</span></label>
          <label class="svc"><input type="checkbox" value="Facial"><span>‚ú® Facial</span></label>
          <label class="svc"><input type="checkbox" value="Other"><span>‚ú® Other</span></label>
        </div>
      </div>

      <button id="submitBtn" class="btn" type="submit">Check In</button>
    </form>

    <!-- SUMMARY -->
    <section id="done" class="hidden">
      <div id="doneBanner" class="banner ok">Thanks for checking in!</div>

      <div class="summary">
        <h3 id="doneTitle">Thanks for checking in!</h3>
        <div id="visitsLeft" class="muted" style="margin:6px 0 10px"></div>
        <div><strong>Services today:</strong> <span id="svcList">‚Äî</span></div>
        <p class="muted" id="cashierNote" style="margin:12px 0 2px">Show reward code at checkout if present.</p>
      </div>

      <button class="btn" type="button" onclick="location.reload()">Done</button>
    </section>
  </main>

  <script>
    const WEBHOOK = 'https://princetonai.app.n8n.cloud/webhook/ai-checkin';

    // Elements
    const form = document.getElementById('form');
    const submitBtn = document.getElementById('submitBtn');
    const alertBox = document.getElementById('alert');
    const needProfileMsg = document.getElementById('needProfileMsg');
    const profileFields = document.getElementById('profileFields');

    const phoneEl = document.getElementById('phone');
    const nameEl = document.getElementById('name');
    const emailEl = document.getElementById('email');
    const birthdayEl = document.getElementById('birthday');
    const smsEl = document.getElementById('sms');
    const servicesBox = document.getElementById('services');

    const doneCard = document.getElementById('done');
    const doneTitle = document.getElementById('doneTitle');
    const doneBanner = document.getElementById('doneBanner');
    const visitsLeftEl = document.getElementById('visitsLeft');
    const svcListEl = document.getElementById('svcList');
    const cashierNoteEl = document.getElementById('cashierNote');

    // State
    let stage = 'lookup'; // 'lookup' -> 'profile' -> 'done'
    let submissionId = null;

    // Phone helpers: keep raw digits while typing, format on blur
    const digitsOnly = s => (s || '').replace(/\D/g,'');
    const fmtPhone = d => {
      d = digitsOnly(d).slice(0,10);
      if (!d) return '';
      if (d.length <= 3) return `(${d}`;
      if (d.length <= 6) return `(${d.slice(0,3)}) ${d.slice(3)}`;
      return `(${d.slice(0,3)}) ${d.slice(3,6)}-${d.slice(6)}`;
    };
    phoneEl.addEventListener('focus', () => { phoneEl.value = digitsOnly(phoneEl.value); });
    phoneEl.addEventListener('blur',  () => { phoneEl.value = fmtPhone(phoneEl.value); });

    function setBanner(kind, msg) {
      alertBox.className = `banner ${kind ? kind : 'hidden'}`;
      alertBox.textContent = msg || '';
      if (!kind) alertBox.classList.add('hidden');
    }

    function showProfileStep() {
      stage = 'profile';
      profileFields.classList.remove('hidden');
      needProfileMsg.classList.remove('hidden');
      submitBtn.textContent = 'Save & Check In';
      // lock the phone to avoid changing idempotency
      phoneEl.readOnly = true;
      phoneEl.style.background = '#f9fafb';
      nameEl.required = true;
      birthdayEl.required = true;
    }

    function showDone(payload) {
      stage = 'done';
      form.classList.add('hidden');
      doneCard.classList.remove('hidden');

      doneBanner.textContent = payload?.message || 'Thanks for checking in!';
      doneTitle.textContent = payload?.message || 'Thanks for checking in!';

      const list = Array.isArray(payload?.services) ? payload.services : [];
      svcListEl.textContent = list.length ? list.join(', ') : '‚Äî';

      // Visits left: from payload if present; otherwise compute from totalVisits (reward every 5th)
      let left = payload?.visitsRemaining;
      if (left == null && typeof payload?.totalVisits === 'number') {
        left = (5 - (payload.totalVisits % 5)) % 5;
      }
      if (left == null) visitsLeftEl.textContent = '';
      else {
        const rewardLabel = payload?.reward?.label || 'Free Eyebrows';
        const isPlural = left !== 1;
        visitsLeftEl.textContent = `${left} visit${isPlural ? 's' : ''} left before your next reward (${rewardLabel}).`;
      }

      cashierNoteEl.textContent = payload?.cashierNote || 'Show reward code at checkout if present.';
    }

    function getSelectedServices() {
      return Array.from(servicesBox.querySelectorAll('input[type="checkbox"]'))
        .filter(cb => cb.checked)
        .map(cb => cb.value);
    }

    async function postJson(body) {
      const res = await fetch(WEBHOOK, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
        body: JSON.stringify(body)
      });
      // n8n always answers JSON on these routes
      const data = await res.json();
      if (!res.ok) {
        const msg = (data && (data.message || data.errorMessage)) || `HTTP ${res.status}`;
        throw new Error(msg);
      }
      return data;
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      setBanner(null);

      // basic gather
      const rawPhone = digitsOnly(phoneEl.value);
      const services = getSelectedServices();

      if (!rawPhone || rawPhone.length < 10) {
        setBanner('err','Please enter a valid 10-digit phone number.');
        phoneEl.focus();
        return;
      }
      if (!services.length) {
        setBanner('err','Please pick at least one service.');
        return;
      }

      // create or reuse submissionId for idempotency
      submissionId ||= (crypto.randomUUID ? crypto.randomUUID() : String(Date.now()));

      // body for both phases
      const body = {
        submissionId,
        phone: rawPhone,
        services
      };

      if (stage === 'profile') {
        body.name = (nameEl.value || '').trim();
        body.email = (emailEl.value || '').trim();
        body.birthday = birthdayEl.value || ''; // ISO (yyyy-mm-dd)
        body.smsOptin = !!smsEl.checked;

        if (!body.name || !body.birthday) {
          setBanner('err','Please fill in your name and birthday.');
          return;
        }
      }

      try {
        submitBtn.disabled = true;

        const resp = await postJson(body);

        // If backend wants profile first:
        if (resp && resp.askProfile) {
          // Keep the same submissionId if backend returns it (or we already had one)
          submissionId = resp.submissionId || submissionId;
          showProfileStep();
          setBanner('ok','Please add your name and birthday to finish.');
          return;
        }

        // Otherwise we are done
        if (resp && (resp.success || resp.ok)) {
          showDone(resp);
          return;
        }

        // Safety fallback
        showDone({
          message: 'Thanks for checking in!',
          services
        });

      } catch (err) {
        console.error(err);
        setBanner('err', err.message || 'Failed to fetch');
      } finally {
        submitBtn.disabled = false;
      }
    });
  </script>
</body>
</html>
